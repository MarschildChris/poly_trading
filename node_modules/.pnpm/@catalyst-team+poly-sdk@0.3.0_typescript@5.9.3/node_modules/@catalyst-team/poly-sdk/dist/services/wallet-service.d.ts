/**
 * Wallet Service
 *
 * Provides smart money analysis features:
 * - Wallet profile analysis
 * - Position tracking
 * - Activity monitoring
 * - Sell detection for follow wallet strategy
 * - Time-based leaderboard and wallet stats
 */
import { DataApiClient, Position, Activity, LeaderboardEntry, LeaderboardPage, LeaderboardTimePeriod, LeaderboardOrderBy, LeaderboardCategory } from '../clients/data-api.js';
import { SubgraphClient } from '../clients/subgraph.js';
import type { UnifiedCache } from '../core/unified-cache.js';
/** Time period (lowercase for SDK, maps to API's uppercase) */
export type TimePeriod = 'day' | 'week' | 'month' | 'all';
/** Sort criteria for period leaderboard (official API supports PNL and VOL) */
export type LeaderboardSortBy = 'volume' | 'pnl';
export type { LeaderboardTimePeriod, LeaderboardOrderBy, LeaderboardCategory };
/**
 * Parsed trade from OrderFilledEvent
 */
export interface ParsedTrade {
    timestamp: number;
    user: string;
    role: 'maker' | 'taker';
    side: 'BUY' | 'SELL';
    tokenId: string;
    tokenAmount: number;
    usdcAmount: number;
    price: number;
}
/**
 * Position tracking for PnL calculation
 */
export interface TokenPosition {
    tokenId: string;
    amount: number;
    avgCost: number;
    totalCost: number;
    realizedPnl: number;
}
/**
 * User stats with PnL
 */
export interface UserPeriodStats {
    address: string;
    volume: number;
    tradeCount: number;
    buyCount: number;
    sellCount: number;
    buyVolume: number;
    sellVolume: number;
    realizedPnl: number;
    unrealizedPnl: number;
    positions: Map<string, TokenPosition>;
}
export interface PeriodLeaderboardEntry {
    address: string;
    rank: number;
    volume: number;
    pnl: number;
    totalPnl: number;
    realizedPnl: number;
    unrealizedPnl: number;
    tradeCount: number;
    buyCount: number;
    sellCount: number;
    buyVolume: number;
    sellVolume: number;
    makerVolume: number;
    takerVolume: number;
    userName?: string;
    profileImage?: string;
}
export interface WalletPeriodStats {
    address: string;
    period: TimePeriod;
    startTime: number;
    endTime: number;
    volume: number;
    tradeCount: number;
    makerVolume: number;
    takerVolume: number;
    makerCount: number;
    takerCount: number;
    splitCount: number;
    mergeCount: number;
    redemptionCount: number;
    redemptionPayout: number;
}
export interface WalletProfile {
    address: string;
    totalPnL: number;
    realizedPnL: number;
    unrealizedPnL: number;
    avgPercentPnL: number;
    positionCount: number;
    tradeCount: number;
    smartScore: number;
    lastActiveAt: Date;
}
export interface WalletActivitySummary {
    address: string;
    activities: Activity[];
    summary: {
        totalBuys: number;
        totalSells: number;
        buyVolume: number;
        sellVolume: number;
        activeMarkets: string[];
    };
}
export interface SellActivityResult {
    totalSellAmount: number;
    sellTransactions: Activity[];
    sellRatio: number;
    shouldExit: boolean;
}
export declare class WalletService {
    private dataApi;
    private subgraph;
    private cache;
    constructor(dataApi: DataApiClient, subgraph: SubgraphClient, cache: UnifiedCache);
    /**
     * Get start timestamp for a time period
     */
    private getPeriodStartTime;
    /**
     * Get comprehensive wallet profile with PnL analysis
     */
    getWalletProfile(address: string): Promise<WalletProfile>;
    /**
     * Get positions for a wallet
     */
    getWalletPositions(address: string): Promise<Position[]>;
    /**
     * Get positions for a specific market
     */
    getPositionsForMarket(address: string, conditionId: string): Promise<Position[]>;
    /**
     * Get wallet activity with summary
     */
    getWalletActivity(address: string, limit?: number): Promise<WalletActivitySummary>;
    /**
     * Get leaderboard
     */
    getLeaderboard(page?: number, pageSize?: number): Promise<LeaderboardPage>;
    /**
     * Get top traders from leaderboard
     */
    getTopTraders(limit?: number): Promise<LeaderboardEntry[]>;
    /**
     * Get leaderboard by time period using official Polymarket API
     *
     * Uses the official Data API which supports time period filtering.
     * This is the recommended method as it uses server-side calculations.
     *
     * @param period - Time period: 'day', 'week', 'month', or 'all'
     * @param limit - Maximum entries to return (default: 50, max: 50)
     * @param sortBy - Sort criteria: 'volume' or 'pnl' (default: 'pnl')
     * @param category - Market category filter (default: 'OVERALL')
     *
     * @example
     * ```typescript
     * // Get top traders of the week by PnL
     * const weeklyByPnl = await walletService.getLeaderboardByPeriod('week', 20, 'pnl');
     *
     * // Get top traders by volume
     * const weeklyByVolume = await walletService.getLeaderboardByPeriod('week', 20, 'volume');
     *
     * // Get politics category leaderboard
     * const politics = await walletService.getLeaderboardByPeriod('week', 20, 'pnl', 'POLITICS');
     * ```
     */
    getLeaderboardByPeriod(period: TimePeriod, limit?: number, sortBy?: LeaderboardSortBy, category?: LeaderboardCategory): Promise<PeriodLeaderboardEntry[]>;
    /**
     * Get a specific user's PnL and ranking for a time period
     *
     * Uses the official Data API's user filter to get a single user's stats.
     *
     * @param address - User's wallet address
     * @param period - Time period: 'day', 'week', 'month', or 'all'
     * @param category - Market category filter (default: 'OVERALL')
     *
     * @example
     * ```typescript
     * // Get user's weekly PnL
     * const stats = await walletService.getUserPeriodPnl(address, 'week');
     * console.log(`Rank: #${stats.rank}, PnL: $${stats.pnl}`);
     *
     * // Get user's monthly PnL in politics category
     * const politicsStats = await walletService.getUserPeriodPnl(address, 'month', 'POLITICS');
     * ```
     */
    getUserPeriodPnl(address: string, period: TimePeriod, category?: LeaderboardCategory): Promise<PeriodLeaderboardEntry | null>;
    /**
     * Get wallet stats for a specific time period
     *
     * Combines data from Orderbook Subgraph (trades) and Activity Subgraph (splits/merges/redemptions)
     *
     * @param address - Wallet address
     * @param period - Time period: 'day', 'week', 'month', or 'all'
     *
     * @example
     * ```typescript
     * // Get wallet's monthly stats
     * const stats = await walletService.getWalletStatsByPeriod(address, 'month');
     * console.log(`Monthly volume: $${stats.volume}`);
     * ```
     */
    getWalletStatsByPeriod(address: string, period: TimePeriod): Promise<WalletPeriodStats>;
    /**
     * Fetch all order filled events in a time period with pagination
     */
    private fetchAllFillsInPeriod;
    /**
     * Parse OrderFilledEvent into user trades
     *
     * OrderFilledEvent 结构:
     * - makerAssetId = "0" (USDC): Maker 卖 USDC = BUY outcome token
     * - makerAssetId = 长数字: Maker 卖 outcome token = SELL
     */
    private parseOrderFilledEvent;
    /**
     * Update position with a trade and calculate realized PnL
     *
     * 买入: 增加持仓，更新平均成本
     * 卖出: 减少持仓，计算已实现盈亏 = 卖出收入 - 成本基础
     */
    private updatePositionWithTrade;
    /**
     * Calculate unrealized PnL for a position
     *
     * 未实现盈亏 = 当前市值 - 总成本
     * 假设当前价格约等于最后交易价格 (简化处理)
     */
    private calculateUnrealizedPnl;
    /**
     * Aggregate user statistics with PnL calculation from order filled events
     *
     * 核心计算流程:
     * 1. 解析 OrderFilledEvent 为标准化的 ParsedTrade
     * 2. 按时间顺序处理每笔交易
     * 3. 追踪每个用户每个 token 的持仓和平均成本
     * 4. 卖出时计算已实现盈亏
     * 5. 期末计算未实现盈亏
     */
    private aggregateUserStatsWithPnl;
    /**
     * Discover active wallets from recent trades
     */
    discoverActiveWallets(limit?: number): Promise<Array<{
        address: string;
        tradeCount: number;
    }>>;
    /**
     * Detect sell activity for a wallet in a specific market
     */
    detectSellActivity(address: string, conditionId: string, sinceTimestamp: number, peakValue?: number): Promise<SellActivityResult>;
    /**
     * Track sell ratio for multiple wallets (aggregated)
     */
    trackGroupSellRatio(addresses: string[], conditionId: string, peakTotalValue: number, sinceTimestamp: number): Promise<{
        cumulativeSellAmount: number;
        sellRatio: number;
        shouldExit: boolean;
        walletSells: Array<{
            address: string;
            sellAmount: number;
        }>;
    }>;
    private calculateSmartScore;
    private calculateVariance;
}
//# sourceMappingURL=wallet-service.d.ts.map