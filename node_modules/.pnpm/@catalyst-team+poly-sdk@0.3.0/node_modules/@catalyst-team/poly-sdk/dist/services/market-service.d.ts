/**
 * Market Service
 *
 * Provides market data and analysis:
 * - Market info and discovery
 * - Orderbook data and analysis
 * - K-Line aggregation from trade data
 * - Spread analysis
 * - Arbitrage detection
 */
import { DataApiClient } from '../clients/data-api.js';
import { GammaApiClient, GammaMarket } from '../clients/gamma-api.js';
import type { UnifiedCache } from '../core/unified-cache.js';
import { RateLimiter } from '../core/rate-limiter.js';
import type { UnifiedMarket, ProcessedOrderbook, ArbitrageOpportunity, KLineInterval, KLineCandle, DualKLineData, RealtimeSpreadAnalysis, Side, Orderbook } from '../core/types.js';
export declare const POLYGON_MAINNET = 137;
export type { Side, Orderbook } from '../core/types.js';
export type PriceHistoryIntervalString = '1h' | '6h' | '1d' | '1w' | 'max';
export interface PriceHistoryParams {
    tokenId: string;
    interval?: PriceHistoryIntervalString;
    startTs?: number;
    endTs?: number;
    fidelity?: number;
}
export interface PricePoint {
    timestamp: number;
    price: number;
}
export interface MarketServiceConfig {
    /** Private key for CLOB client auth (optional, for authenticated endpoints) */
    privateKey?: string;
    /** Chain ID (default: Polygon mainnet 137) */
    chainId?: number;
}
/**
 * CLOB Market type (from CLOB API)
 *
 * This represents the raw market data from the CLOB API.
 * For merged market data with volume/liquidity, use UnifiedMarket from core/types.ts.
 */
export interface Market {
    conditionId: string;
    questionId?: string;
    marketSlug: string;
    question: string;
    description?: string;
    tokens: MarketToken[];
    active: boolean;
    closed: boolean;
    acceptingOrders: boolean;
    endDateIso?: string | null;
    negRisk?: boolean;
    minimumOrderSize?: number;
    minimumTickSize?: number;
}
/**
 * Token in a CLOB market
 * Same structure as MarketToken in core/types.ts
 */
export interface MarketToken {
    tokenId: string;
    outcome: string;
    price: number;
    winner?: boolean;
}
export declare class MarketService {
    private gammaApi;
    private dataApi;
    private rateLimiter;
    private cache;
    private config?;
    private clobClient;
    private initialized;
    constructor(gammaApi: GammaApiClient | undefined, dataApi: DataApiClient | undefined, rateLimiter: RateLimiter, cache: UnifiedCache, config?: MarketServiceConfig | undefined);
    private ensureInitialized;
    /**
     * Get market from CLOB by condition ID
     */
    getClobMarket(conditionId: string): Promise<Market>;
    /**
     * Get multiple markets from CLOB
     */
    getClobMarkets(nextCursor?: string): Promise<{
        markets: Market[];
        nextCursor: string;
    }>;
    /**
     * Get orderbook for a single token
     */
    getTokenOrderbook(tokenId: string): Promise<Orderbook>;
    /**
     * Get orderbooks for multiple tokens
     */
    getTokenOrderbooks(params: Array<{
        tokenId: string;
        side: Side;
    }>): Promise<Map<string, Orderbook>>;
    /**
     * Get processed orderbook with arbitrage analysis for a market
     */
    getProcessedOrderbook(conditionId: string): Promise<ProcessedOrderbook>;
    /**
     * Get price history for a token
     */
    getPricesHistory(params: PriceHistoryParams): Promise<PricePoint[]>;
    /**
     * Get midpoint price for a token
     */
    getMidpoint(tokenId: string): Promise<number>;
    /**
     * Get spread for a token
     */
    getSpread(tokenId: string): Promise<number>;
    /**
     * Get last trade price for a token
     */
    getLastTradePrice(tokenId: string): Promise<number>;
    /**
     * Get market by slug or condition ID
     */
    getMarket(identifier: string): Promise<UnifiedMarket>;
    private getMarketBySlug;
    private getMarketByConditionId;
    /**
     * Get K-Line candles for a market (single token)
     */
    getKLines(conditionId: string, interval: KLineInterval, options?: {
        limit?: number;
        tokenId?: string;
        outcomeIndex?: number;
    }): Promise<KLineCandle[]>;
    /**
     * Get dual K-Lines (YES + NO tokens)
     */
    getDualKLines(conditionId: string, interval: KLineInterval, options?: {
        limit?: number;
    }): Promise<DualKLineData>;
    /**
     * Aggregate trades into K-Line candles
     */
    private aggregateToKLines;
    /**
     * Analyze historical spread from trade close prices (for backtesting)
     *
     * This uses trade close prices, not orderbook bid/ask.
     * Useful for:
     * - Historical analysis / backtesting
     * - Understanding past price movements
     * - Identifying patterns when orderbook data unavailable
     */
    private analyzeHistoricalSpread;
    /**
     * Calculate real-time spread from orderbook (for live trading)
     *
     * This uses orderbook bid/ask prices for accurate arbitrage detection.
     * Useful for:
     * - Real-time arbitrage execution
     * - Live trading decisions
     * - Accurate profit calculations
     */
    private calculateRealtimeSpread;
    /**
     * Get real-time spread analysis only (without K-lines)
     * Use this for quick arbitrage checks
     */
    getRealtimeSpread(conditionId: string): Promise<RealtimeSpreadAnalysis>;
    /**
     * Get processed orderbook with analytics (alias for getProcessedOrderbook)
     */
    getOrderbook(conditionId: string): Promise<ProcessedOrderbook>;
    /**
     * Detect arbitrage opportunity
     *
     * 使用有效价格（考虑镜像订单）计算套利机会
     * 详细原理见: docs/01-polymarket-orderbook-arbitrage.md
     */
    detectArbitrage(conditionId: string, threshold?: number): Promise<ArbitrageOpportunity | null>;
    /**
     * Get trending markets
     */
    getTrendingMarkets(limit?: number): Promise<GammaMarket[]>;
    /**
     * Search markets
     */
    searchMarkets(params: {
        active?: boolean;
        closed?: boolean;
        limit?: number;
        offset?: number;
        order?: string;
    }): Promise<GammaMarket[]>;
    /**
     * Detect market signals (volume surge, depth imbalance, whale trades)
     */
    detectMarketSignals(conditionId: string): Promise<Array<{
        type: 'volume_surge' | 'depth_imbalance' | 'whale_trade' | 'momentum';
        severity: 'low' | 'medium' | 'high';
        details: Record<string, unknown>;
    }>>;
    private normalizeClobMarket;
    private processOrderbooks;
    private mergeMarkets;
    private fromGammaMarket;
    private fromClobMarket;
}
export declare function getIntervalMs(interval: KLineInterval): number;
//# sourceMappingURL=market-service.d.ts.map